<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <head>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    </head>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
        integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous">
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"
        integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous">
    </script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"
        integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous">
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/2.4.1/lodash.min.js"></script>
</head>

<body>
    <table class="table">
        <button class="btn btn-secondary">Order by Title</button>
        <button class="btn btn-secondary mx-2">Order by Album</button>
        <button class="btn btn-secondary">Order by Year</button>
        <thead>
            <tr align="center">
                <th scope="col">Title</th>
                <th scope="col">Year</th>
                <th scope="col">Album</th>
                <th scope="col">Reissue</th>
            </tr>
        </thead>
        <tbody id="id_parent">

        </tbody>
    </table>
</body>
<script>
    const getData = () => {
        let tracks=[]
        fetch('sonography.txt', {
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                }
            })
            .then(function (response) {
                //console.log(response)
                return response.text();
            })
            .then(async function (data) {
                let source = data
                source = source.replace(/\n/g, "<br>");

                let textbody = document.createElement('a')
                var data = new Blob([source], {
                    type: 'text/plain'
                });
                const text = await (new Response(data)).text();

                let regex = /(.*)/g;
                let lineparsed = text.match(regex);
                lineparsed = lineparsed.filter(element => element.length > 5)

                lineparsed.map((line, i) => {
                    let reissue = "";
                    regex = /^(.*)[[]/g
                    let foundtitle = line.match(regex)
                    foundtitle = String(foundtitle)
                    let title = foundtitle.substring(0, foundtitle.length - 1);
                    regex = /[^0-9.][0-9][0-9][0-9][0-9?][^0-9.]/;
                    let foundyear = line.match(regex);
                    foundyear = String(foundyear)
                    year = foundyear.substring(1)
                    regex =
                        /[12][90][0-9][0-9?]/g;
                    let foundreissue = line.match(regex)
                    //console.log(line)

                    regex = /[[][A-Z](?!^Mixed)(.*?)[(]/g;
                    let foundalbum = line.match(regex);
                    foundalbum = String(foundalbum)
                    let album = foundalbum.substring(1,foundalbum.length-2)
                    console.log(album)
                    foundreissue.map((el, i) => {
                        el = Number(el);
                        if (el < 1980) {
                            el = null
                        };
                        //console.log(el)
                    })
                    if (foundreissue.length > 1) {
                        foundreissue = _.max(foundreissue)
                        if (foundreissue>foundyear){reissue=foundreissue}
                    }
                    //if (foundyear.length>1){console.log(foundyear)}
                    //entry.innerHTML = `${i} ${title} - ${foundyear}`;
                    let track = new Track(title, Number(year), album, reissue,lineparsed[i])
                    tracks.push(track)

                })
                //console.log(JSON.stringify(tracks))

            });
    }
    class Track {
        constructor(_title, _year,_album, _reissue,_entry) {
            this.title = _title;
            this.year = _year;
            this.album = _album;
            this.reissue = _reissue;
            this.entry=_entry
            this.render()
        }

        render() {
            let newTr = $("<tr></tr>")
            $("#id_parent").append(newTr);
            $(newTr).append(`
      <td align="center" class="align-middle">${this.title}</td>
      <td align="center" class="align-middle">${this.year}</td>
      <td align="center" class="align-middle">${this.album}</td>
      <td align="center" class="align-middle">${this.reissue}</td>
            
    `)
        }

    }
    getData()
</script>

</html>